
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>optimization &#8212; TeNPy 0.4.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="shortcut icon" href="../_static/logo.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OptimizationFlag" href="tenpy.tools.optimization.OptimizationFlag.html" />
    <link rel="prev" title="omp_set_nthreads" href="tenpy.tools.process.omp_set_nthreads.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tenpy.tools.optimization.OptimizationFlag.html" title="OptimizationFlag"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tenpy.tools.process.omp_set_nthreads.html" title="omp_set_nthreads"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TeNPy 0.4.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../reference.html" >Tenpy Reference</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="tenpy.tools.html" accesskey="U">tools</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="optimization">
<h1>optimization<a class="headerlink" href="#optimization" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>full name: tenpy.tools.optimization</p></li>
<li><p>parent module: <a class="reference internal" href="tenpy.tools.html#module-tenpy.tools" title="tenpy.tools"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tenpy.tools</span></code></a></p></li>
<li><p>type: module</p></li>
</ul>
<p class="rubric">Classes</p>
<table class="longtable docutils align-center">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="tenpy.tools.optimization.OptimizationFlag.html#tenpy.tools.optimization.OptimizationFlag" title="tenpy.tools.optimization.OptimizationFlag"><code class="xref py py-obj docutils literal notranslate"><span class="pre">OptimizationFlag</span></code></a></p></td>
<td><p>Options for the global ‘optimization level’ used for dynamical optimizations.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="tenpy.tools.optimization.temporary_level.html#tenpy.tools.optimization.temporary_level" title="tenpy.tools.optimization.temporary_level"><code class="xref py py-obj docutils literal notranslate"><span class="pre">temporary_level</span></code></a>(temporary_level)</p></td>
<td><p>Context manager to temporarily set the optimization level to a different value.</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Functions</p>
<table class="longtable docutils align-center">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="tenpy.tools.optimization.get_level.html#tenpy.tools.optimization.get_level" title="tenpy.tools.optimization.get_level"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_level</span></code></a>()</p></td>
<td><p>Return the global optimization level.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="tenpy.tools.optimization.optimize.html#tenpy.tools.optimization.optimize" title="tenpy.tools.optimization.optimize"><code class="xref py py-obj docutils literal notranslate"><span class="pre">optimize</span></code></a>([level_compare])</p></td>
<td><p>Called by algorithms to check whether it should (try to) do some optimizations.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="tenpy.tools.optimization.set_level.html#tenpy.tools.optimization.set_level" title="tenpy.tools.optimization.set_level"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_level</span></code></a>([level])</p></td>
<td><p>Set the global optimization level.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="tenpy.tools.optimization.to_OptimizationFlag.html#tenpy.tools.optimization.to_OptimizationFlag" title="tenpy.tools.optimization.to_OptimizationFlag"><code class="xref py py-obj docutils literal notranslate"><span class="pre">to_OptimizationFlag</span></code></a>(level)</p></td>
<td><p>Convert strings and int to a valid OptimizationFlag.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="tenpy.tools.optimization.use_cython.html#tenpy.tools.optimization.use_cython" title="tenpy.tools.optimization.use_cython"><code class="xref py py-obj docutils literal notranslate"><span class="pre">use_cython</span></code></a>([func, replacement, check_doc])</p></td>
<td><p>Decorator to replace a function with a Cython-equivalent from _npc_helper.pyx.</p></td>
</tr>
</tbody>
</table>
<p class="rubric">Module description</p>
<span class="target" id="module-tenpy.tools.optimization"></span><p>Optimization options for this library.</p>
<p>Let me start with a <a class="reference external" href="http://wiki.c2.com/?RulesOfOptimization">quote</a> of “Micheal Jackson”
(a programmer, not the musician):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">First</span> <span class="n">rule</span> <span class="n">of</span> <span class="n">optimization</span><span class="p">:</span> <span class="s2">&quot;Don&#39;t do it.&quot;</span>
<span class="n">Second</span> <span class="n">rule</span> <span class="n">of</span> <span class="n">optimization</span> <span class="p">(</span><span class="k">for</span> <span class="n">experts</span> <span class="n">only</span><span class="p">):</span> <span class="s2">&quot;Don&#39;t do it yet.&quot;</span>
<span class="n">Third</span> <span class="n">rule</span> <span class="n">of</span> <span class="n">optimization</span><span class="p">:</span> <span class="s2">&quot;Profile before optimizing.&quot;</span>
</pre></div>
</div>
<p>Luckily, following the third optimization rule, namely profiling code, is
fairly simple in python, see the <a class="reference external" href="https://docs.python.org/3/library/profile.html">documentation</a>.
If you have a python skript running your code, you can simply call it with
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">&quot;cProfile&quot;</span> <span class="pre">-s</span> <span class="pre">&quot;tottime&quot;</span> <span class="pre">your_skript.py</span></code>. Alternatively, save the profiling statistics
with <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">&quot;cProfile&quot;</span> <span class="pre">-o</span> <span class="pre">&quot;profile_data.stat&quot;</span> <span class="pre">your_skript.py</span></code> and
run these few lines of python code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pstats</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Pstats</span><span class="p">(</span><span class="s2">&quot;profile_data.stat&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumtime&#39;</span><span class="p">)</span>  <span class="c1"># sort by &#39;cumtime&#39; column</span>
<span class="n">p</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>   <span class="c1"># prints first 30 entries</span>
</pre></div>
</div>
<p>That being said, I actually did profile and optimize (parts of) the library; and there are a few
knobs you can turn to tweak the most out of this library, explained in the following.</p>
<ol class="arabic">
<li><p>Simply install the ‘bottleneck’ python package, which allows to optimize slow parts of numpy,
most notably ‘NaN’ checking.</p></li>
<li><p>Figure out which numpy/scipy/python you are using. As explained in <a class="reference internal" href="../INSTALL.html"><span class="doc">Installation instructions: from source</span></a>,
we recommend to use the Python distributed provided by Intel or Anaconda. They ship with numpy
and scipy which use Intels MKL library, such that e.g. <code class="docutils literal notranslate"><span class="pre">np.tensordot</span></code> is parallelized to use
multiple cores.</p></li>
<li><p>In case you didn’t do that yet: some parts of the library are written in both python and Cython
with the same interface, so you can simply compile the Cython code, as explained in
<a class="reference internal" href="../INSTALL.html"><span class="doc">Installation instructions: from source</span></a>. Then everything should work the same way from a user perspective,
while internally the faster, pre-compiled cython code from <code class="docutils literal notranslate"><span class="pre">tenpy/linalg/_npc_helper.pyx</span></code>
is used. This should also be a safe thing to do.
The replacement of the optimized functions is done by the decorator <a class="reference internal" href="tenpy.tools.optimization.use_cython.html#tenpy.tools.optimization.use_cython" title="tenpy.tools.optimization.use_cython"><code class="xref py py-func docutils literal notranslate"><span class="pre">use_cython()</span></code></a>.</p></li>
<li><p>One of the great things about python is its dynamical nature - anything can be done at runtime.
In that spirit, this module allows to set a global  “optimization level” which can be changed
<em>dynamically</em> (i.e., during runtime) with <a class="reference internal" href="tenpy.tools.optimization.set_level.html#tenpy.tools.optimization.set_level" title="tenpy.tools.optimization.set_level"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_level()</span></code></a>. The library will then try some
extra optimiztion, most notably skip sanity checks of arguments.
The possible choices for this global level are given by the <a class="reference internal" href="tenpy.tools.optimization.OptimizationFlag.html#tenpy.tools.optimization.OptimizationFlag" title="tenpy.tools.optimization.OptimizationFlag"><code class="xref py py-class docutils literal notranslate"><span class="pre">OptimizationFlag</span></code></a>.
The default initial value for the global optimization level can be adjusted by the environment
variable <cite>TENPY_OPTIMIZE</cite>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When this optimizing is enabled, we skip (some) sanity checks.
Thus, errors will not be detected that easily, and debugging is much harder!
We recommend to use this kind of optimization only for code which you succesfully have run
before with (very) similar parmeters!
Enable this optimization only during the parts of the code where it is really necessary.
The context manager <a class="reference internal" href="tenpy.tools.optimization.temporary_level.html#tenpy.tools.optimization.temporary_level" title="tenpy.tools.optimization.temporary_level"><code class="xref py py-class docutils literal notranslate"><span class="pre">temporary_level</span></code></a> can help with that.
Check whether it actually helps - if it doesn’t, keep the optimization disabled!
Some parts of the library already do that as well (e.g. DMRG after the first sweep).</p>
</div>
</li>
<li><p>You might want to try some different compile time options for the cython code, set in the
<cite>setup.py</cite> in the top directory of the repository.
Since the <cite>setup.py</cite> reads out the <cite>TENPY_OPTIMIZE</cite>
environment variable, you can simple use an <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">TENPY_OPTIMIZE=3</span></code> (in your bash/terminal)
right before compilation. An <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">TENPY_OPTIMIZE=0</span></code> activates profiling hooks instead.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This increases the probability of getting segmentation faults and anyway might not
help that much; in the crucial parts of the cython code, these optimizations are already
applied. We do <em>not</em> recommend using this!</p>
</div>
</li>
</ol>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="tenpy.tools.process.omp_set_nthreads.html"
                        title="previous chapter">omp_set_nthreads</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tenpy.tools.optimization.OptimizationFlag.html"
                        title="next chapter">OptimizationFlag</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../userguide.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../reference.html">Tenpy Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="tenpy.algorithms.html">algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="tenpy.linalg.html">linalg</a></li>
<li class="toctree-l2"><a class="reference internal" href="tenpy.models.html">models</a></li>
<li class="toctree-l2"><a class="reference internal" href="tenpy.networks.html">networks</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="tenpy.tools.html">tools</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="tenpy.tools.params.html">params</a></li>
<li class="toctree-l3"><a class="reference internal" href="tenpy.tools.misc.html">misc</a></li>
<li class="toctree-l3"><a class="reference internal" href="tenpy.tools.math.html">math</a></li>
<li class="toctree-l3"><a class="reference internal" href="tenpy.tools.fit.html">fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="tenpy.tools.string.html">string</a></li>
<li class="toctree-l3"><a class="reference internal" href="tenpy.tools.process.html">process</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">optimization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tenpy.version.html">version</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tenpy.tools.optimization.OptimizationFlag.html" title="OptimizationFlag"
             >next</a> |</li>
        <li class="right" >
          <a href="tenpy.tools.process.omp_set_nthreads.html" title="omp_set_nthreads"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TeNPy 0.4.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../reference.html" >Tenpy Reference</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="tenpy.tools.html" >tools</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2019, TeNPy Developers.
      Last updated on Aug 10, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.0.
    </div>
  </body>
</html>