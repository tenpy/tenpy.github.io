
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>tenpy.algorithms.tdvp &#8212; TeNPy 0.4.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="shortcut icon" href="../../../_static/logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">TeNPy 0.4.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for tenpy.algorithms.tdvp</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Time Dependant Variational Principle (TDVP) with MPS (finite version only).</span>

<span class="sd">The TDVP MPS algorithm was first proposed by [Haegeman2011]_. However the stability of the</span>
<span class="sd">algorithm was later improved in [Haegeman2016]_, that we are following in this implementation.</span>
<span class="sd">The general idea of the algorithm is to project the quantum time evolution in the manyfold of MPS</span>
<span class="sd">with a given bond dimension. Compared to e.g. TEBD, the algorithm has several advantages:</span>
<span class="sd">e.g. it conserves the unitarity of the time evolution and the energy (for the single-site version),</span>
<span class="sd">and it is suitable for time evolution of Hamiltonian with arbitrary long range in the form of MPOs.</span>
<span class="sd">We have implemented the one-site formulation which **does not** allow for growth of the bond dimension,</span>
<span class="sd">and the two-site algorithm which does allow the bond dimension to grow - but requires truncation as in the TEBD case.</span>

<span class="sd">.. todo ::</span>
<span class="sd">    This is still a beta version, use with care.</span>
<span class="sd">    The interface might still change.</span>

<span class="sd">.. todo ::</span>
<span class="sd">    long-term: Much of the code is similar as in DMRG. To avoid too much duplicated code,</span>
<span class="sd">    we should have a general way to sweep through an MPS and updated one or two sites, used in both</span>
<span class="sd">    cases.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tenpy.networks.mpo</span> <span class="k">import</span> <span class="n">MPOEnvironment</span>
<span class="kn">import</span> <span class="nn">tenpy.linalg.np_conserved</span> <span class="k">as</span> <span class="nn">npc</span>
<span class="kn">from</span> <span class="nn">tenpy.tools.params</span> <span class="k">import</span> <span class="n">get_parameter</span>
<span class="kn">from</span> <span class="nn">tenpy.linalg.lanczos</span> <span class="k">import</span> <span class="n">LanczosEvolution</span>
<span class="kn">from</span> <span class="nn">tenpy.algorithms.truncation</span> <span class="k">import</span> <span class="n">svd_theta</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Engine&#39;</span><span class="p">,</span> <span class="s1">&#39;H0_mixed&#39;</span><span class="p">,</span> <span class="s1">&#39;H1_mixed&#39;</span><span class="p">,</span> <span class="s1">&#39;H2_mixed&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Engine"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine">[docs]</a><span class="k">class</span> <span class="nc">Engine</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Time dependant variational principle &#39;Engine&#39;</span>

<span class="sd">    You can call :meth:`run_one_site` for single-site TDVP, or</span>
<span class="sd">    :meth:`run_two_sites` for two-site TDVP.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psi : :class:`~tenpy.networks.mps.MPS`</span>
<span class="sd">        Initial state to be time evolved. Modified in place.</span>
<span class="sd">    model : :class:`~tenpy.models.model.MPOModel`</span>
<span class="sd">        The model representing the Hamiltonian for which we want to find the ground state.</span>
<span class="sd">    TDVP_params : dict</span>
<span class="sd">        Further optional parameters as described in the following table.</span>
<span class="sd">        Use ``verbose&gt;0`` to print the used parameters during runtime.</span>

<span class="sd">        ============== ========= ===============================================================</span>
<span class="sd">        key            type      description</span>
<span class="sd">        ============== ========= ===============================================================</span>
<span class="sd">        start_time     float     Initial value for :attr:`evolved_time`</span>
<span class="sd">        -------------- --------- ---------------------------------------------------------------</span>
<span class="sd">        dt             float     Time step of the Trotter error</span>
<span class="sd">        -------------- --------- ---------------------------------------------------------------</span>
<span class="sd">        trunc_params   dict      Truncation parameters as described in</span>
<span class="sd">                                 :func:`~tenpy.algorithms.truncation.truncate`</span>
<span class="sd">        ============== ========= ===============================================================</span>
<span class="sd">    environment :  :class:&#39;~tenpy.networks.mpo.MPOEnvironment` | None</span>
<span class="sd">        Initial environment. If ``None`` (default), it will be calculated at the beginning.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    verbose : int</span>
<span class="sd">        Level of verbosity (i.e. how much status information to print); higher=more output.</span>
<span class="sd">    evolved_time : float | complex</span>
<span class="sd">        Indicating how long `psi` has been evolved, ``psi = exp(-i * evolved_time * H) psi(t=0)``.</span>
<span class="sd">    psi : :class:`~tenpy.networks.mps.MPS`</span>
<span class="sd">        The MPS, time evolved in-place.</span>
<span class="sd">    TDVP_params: dict</span>
<span class="sd">        Optional parameters, see :func:`run` and :func:`run_GS` for more details.</span>
<span class="sd">    environment : :class:`~tenpy.networks.mpo.MPOEnvironment`</span>
<span class="sd">        The environment, storing the `LP` and `RP` to avoid recalculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">TDVP_params</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">TDVP_params</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;TDVP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TDVP_params</span> <span class="o">=</span> <span class="n">TDVP_params</span>
        <span class="k">if</span> <span class="n">environment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">environment</span> <span class="o">=</span> <span class="n">MPOEnvironment</span><span class="p">(</span><span class="n">psi</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">H_MPO</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evolved_time</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">TDVP_params</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;TDVP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">H_MPO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">psi</span><span class="o">.</span><span class="n">finite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;TDVP is only implemented for finite boundary conditions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">TDVP_params</span><span class="p">,</span> <span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;TDVP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trunc_params</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">TDVP_params</span><span class="p">,</span> <span class="s1">&#39;trunc_params&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">&#39;TDVP&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_steps</span> <span class="o">=</span> <span class="n">get_parameter</span><span class="p">(</span><span class="n">TDVP_params</span><span class="p">,</span> <span class="s1">&#39;N_steps&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;TDVP&#39;</span><span class="p">)</span>

    <span class="c1"># Actual calculation</span>
<div class="viewcode-block" id="Engine.run_one_site"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.run_one_site">[docs]</a>    <span class="k">def</span> <span class="nf">run_one_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the TDVP algorithm with the one site algorithm.</span>

<span class="sd">        .. warning ::</span>
<span class="sd">            Be aware that the bond dimension will not increase!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N_steps : integer. Number of steps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">N_steps</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_steps</span> <span class="o">=</span> <span class="n">N_steps</span>
        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO</span><span class="o">.</span><span class="n">_W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#Initialize in the correct order</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">itranspose</span><span class="p">((</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_left_right</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_right_left</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evolved_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolved_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span></div>

<div class="viewcode-block" id="Engine.run_two_sites"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.run_two_sites">[docs]</a>    <span class="k">def</span> <span class="nf">run_two_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the TDVP algorithm with two sites update.</span>

<span class="sd">        The bond dimension will increase. Truncation happens at every step of the</span>
<span class="sd">        sweep, according to the parameters set in trunc_params.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N_steps : integer. Number of steps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">N_steps</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N_steps</span> <span class="o">=</span> <span class="n">N_steps</span>
        <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO</span><span class="o">.</span><span class="n">_W</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#Initialize in the correct order</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">itranspose</span><span class="p">((</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_left_right_two</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_right_left_two</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evolved_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolved_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span></div>

    <span class="k">def</span> <span class="nf">_del_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete correctly the environment once the tensor at site i is updated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i : int</span>
<span class="sd">            Site at which the tensor has been updated</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">del_LP</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">del_RP</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Engine.sweep_left_right"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.sweep_left_right">[docs]</a>    <span class="k">def</span> <span class="nf">sweep_left_right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the sweep left-&gt;right of the second order TDVP scheme with one site update.</span>

<span class="sd">        Evolve from 0.5*dt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">):</span>
            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="c1"># Get theta</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">B</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
                                      <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;vR&#39;</span><span class="p">))</span>  <span class="c1">#theta[vL,p,vR]=s[vL,vR]*self.psi[p,vL,vR]</span>
            <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">W1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">get_W</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_theta_h1</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="c1"># SVD and update environment</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_svd_left_right</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_SR</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">to_ndarray</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_correct</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Apply expm (-dt H) for 0-site</span>

                <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">B_jp1</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">B_jp1</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
                <span class="n">Lpp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Rp</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Rp</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
                <span class="n">Rp</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Rp</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vL*&#39;</span><span class="p">,</span> <span class="s1">&#39;vR*&#39;</span><span class="p">])</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">H0_mixed</span><span class="p">(</span><span class="n">Lpp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">)</span>

                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_s_h0</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">to_ndarray</span><span class="p">())</span></div>

<div class="viewcode-block" id="Engine.sweep_left_right_two"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.sweep_left_right_two">[docs]</a>    <span class="k">def</span> <span class="nf">sweep_left_right_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the sweep left-&gt;right of the second order TDVP scheme with two sites update.</span>

<span class="sd">        Evolve from 0.5*dt&quot;&quot;&quot;</span>
        <span class="n">theta_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_theta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">theta</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">theta_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">))</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">)</span>
            <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">W1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">get_W</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">W2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">get_W</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_theta_h2</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">]],</span> <span class="n">qconj</span><span class="o">=</span><span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># SVD and update environment</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">renorm</span> <span class="o">=</span> <span class="n">svd_theta</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunc_params</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">npc</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split_legs</span><span class="p">(</span><span class="s1">&#39;(vL.p0)&#39;</span><span class="p">)</span>
            <span class="n">U</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">split_legs</span><span class="p">(</span><span class="s1">&#39;(vR.p1)&#39;</span><span class="p">)</span>
            <span class="n">V</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_correct</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_SR</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_correct</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Apply expm (-dt H) for 1-site</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_theta</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
                <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_theta_h1</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">theta_old</span> <span class="o">=</span> <span class="n">theta</span>
                <span class="n">theta_old</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Engine.sweep_right_left"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.sweep_right_left">[docs]</a>    <span class="k">def</span> <span class="nf">sweep_right_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the sweep right-&gt;left of the second order TDVP scheme with one site update.</span>

<span class="sd">        Evolve from 0.5*dt&quot;&quot;&quot;</span>
        <span class="n">expectation_O</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="c1"># Get theta</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">B</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
                                      <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;vL&#39;</span><span class="p">))</span>  <span class="c1">#theta[vL,p,vR]=s[vL,vR]*self.psi[p,vL,vR]</span>

            <span class="c1"># Apply expm (-dt H) for 1-site</span>
            <span class="n">chiB</span><span class="p">,</span> <span class="n">chiA</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">to_ndarray</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">W1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">get_W</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_theta_h1</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="c1"># SVD and update environment</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta_svd_right_left</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_SL</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">to_ndarray</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_correct</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Apply expm (-dt H) for 0-site</span>

                <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
                <span class="n">B_jm1</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">B_jm1</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
                <span class="n">Lp</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">])</span>
                <span class="n">Lp</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">V</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;vR*&#39;</span><span class="p">,</span> <span class="s1">&#39;vL*&#39;</span><span class="p">])</span>
                <span class="n">H</span> <span class="o">=</span> <span class="n">H0_mixed</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_s_h0</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">to_ndarray</span><span class="p">())</span></div>

<div class="viewcode-block" id="Engine.sweep_right_left_two"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.sweep_right_left_two">[docs]</a>    <span class="k">def</span> <span class="nf">sweep_right_left_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the sweep left-&gt;right of the second order TDVP scheme with two sites update.</span>

<span class="sd">        Evolve from 0.5*dt&quot;&quot;&quot;</span>
        <span class="n">theta_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_theta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">theta_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_B</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">))</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">)</span>
            <span class="n">theta</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">)</span>
            <span class="c1">#theta=self.psi.get_theta(j,2)</span>
            <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">W1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">get_W</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">W2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">get_W</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_theta_h2</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">W2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">]],</span> <span class="n">qconj</span><span class="o">=</span><span class="p">[</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># SVD and update environment</span>
            <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">renorm</span> <span class="o">=</span> <span class="n">svd_theta</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trunc_params</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">npc</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split_legs</span><span class="p">(</span><span class="s1">&#39;(vL.p0)&#39;</span><span class="p">)</span>
            <span class="n">U</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">split_legs</span><span class="p">(</span><span class="s1">&#39;(vR.p1)&#39;</span><span class="p">)</span>
            <span class="n">V</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_correct</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_SR</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">set_B</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_del_correct</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Apply expm (-dt H) for 1-site</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">get_theta</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
                <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_LP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_RP</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_theta_h1</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">theta_old</span> <span class="o">=</span> <span class="n">theta</span>
                <span class="n">theta</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Engine.update_theta_h1"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.update_theta_h1">[docs]</a>    <span class="k">def</span> <span class="nf">update_theta_h1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update with the one site Hamiltonian.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lp : :class:`~tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            tensor representing the left environment</span>
<span class="sd">        Rp :  :class:`~tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            tensor representing the right environment</span>
<span class="sd">        theta :  :class:`~tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            the theta tensor which needs to be updated</span>
<span class="sd">        W : :class:`~tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            MPO which is applied to the &#39;p&#39; leg of theta</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H1_mixed</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="c1">#Initialize Lanczos</span>
        <span class="n">parameters_lanczos_h1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">}</span>
        <span class="n">lanczos_h1</span> <span class="o">=</span> <span class="n">LanczosEvolution</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parameters_lanczos_h1</span><span class="p">)</span>
        <span class="n">theta</span><span class="p">,</span> <span class="n">N_h1</span> <span class="o">=</span> <span class="n">lanczos_h1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.p.vR)&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">theta</span></div>

<div class="viewcode-block" id="Engine.update_theta_h2"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.update_theta_h2">[docs]</a>    <span class="k">def</span> <span class="nf">update_theta_h2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">W0</span><span class="p">,</span> <span class="n">W1</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update with the two sites Hamiltonian</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            tensor representing the left environment</span>
<span class="sd">        Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            tensor representing the right environment</span>
<span class="sd">        theta : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            the theta tensor which needs to be updated</span>
<span class="sd">        W : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            MPO which is applied to the &#39;p0&#39; leg of theta</span>
<span class="sd">        W1 : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            MPO which is applied to the &#39;p1&#39; leg of theta</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H2_mixed</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">W0</span><span class="p">,</span> <span class="n">W1</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="c1">#Initialize Lanczos</span>
        <span class="n">parameters_lanczos_h1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">}</span>
        <span class="n">lanczos_h1</span> <span class="o">=</span> <span class="n">LanczosEvolution</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">psi0</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parameters_lanczos_h1</span><span class="p">)</span>
        <span class="n">theta</span><span class="p">,</span> <span class="n">N_h1</span> <span class="o">=</span> <span class="n">lanczos_h1</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.p0.p1.vR)&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">theta</span></div>

<div class="viewcode-block" id="Engine.theta_svd_left_right"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.theta_svd_left_right">[docs]</a>    <span class="k">def</span> <span class="nf">theta_svd_left_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the SVD from left to right</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta: :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            the theta tensor on which the SVD is applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">])</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.p)&#39;</span><span class="p">])</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_anonymous_svd</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_anonymous_svd</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">)</span>
        <span class="n">s_ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">vR_U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">get_leg</span><span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">)</span>
        <span class="n">vL_V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_leg</span><span class="p">(</span><span class="s1">&#39;vL&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">Array</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">s_ndarray</span><span class="p">,</span> <span class="p">[</span><span class="n">vR_U</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">vL_V</span><span class="o">.</span><span class="n">conj</span><span class="p">()],</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">qtotal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">iset_leg_labels</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span></div>

<div class="viewcode-block" id="Engine.set_anonymous_svd"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.set_anonymous_svd">[docs]</a>    <span class="k">def</span> <span class="nf">set_anonymous_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">new_label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Relabel the svd</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        U : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            the tensor which lacks a leg_label</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">get_leg_labels</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_labels</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">list_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">list_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">iset_leg_labels</span><span class="p">(</span><span class="n">list_labels</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">replace_label</span><span class="p">(</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">new_label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span></div>

<div class="viewcode-block" id="Engine.theta_svd_right_left"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.theta_svd_right_left">[docs]</a>    <span class="k">def</span> <span class="nf">theta_svd_right_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs the SVD from right to left</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : :class:`tenpy.linalg.np_conserved.Array`,</span>
<span class="sd">            The theta tensor on which the SVD is applied</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="n">V</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">U</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(p.vR)&#39;</span><span class="p">])</span>
        <span class="n">U</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_anonymous_svd</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_anonymous_svd</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">)</span>
        <span class="n">s_ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">vL_U</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">get_leg</span><span class="p">(</span><span class="s1">&#39;vL&#39;</span><span class="p">)</span>
        <span class="n">vR_V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">get_leg</span><span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">Array</span><span class="o">.</span><span class="n">from_ndarray</span><span class="p">(</span><span class="n">s_ndarray</span><span class="p">,</span> <span class="p">[</span><span class="n">vR_V</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span> <span class="n">vL_U</span><span class="o">.</span><span class="n">conj</span><span class="p">()],</span>
                                   <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">qtotal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">iset_leg_labels</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">U</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">V</span></div>

<div class="viewcode-block" id="Engine.update_s_h0"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.Engine.html#tenpy.algorithms.tdvp.Engine.update_s_h0">[docs]</a>    <span class="k">def</span> <span class="nf">update_s_h0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update with the zero site Hamiltonian (update of the singular value)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        s : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">            representing the singular value matrix which is updated</span>
<span class="sd">        H : H0_mixed</span>
<span class="sd">            zero site Hamiltonian that we need to apply on the singular value matrix</span>
<span class="sd">        dt : complex number</span>
<span class="sd">            time step of the evolution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Initialize Lanczos</span>
        <span class="n">parameters_lanczos_h1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">dt</span><span class="p">}</span>
        <span class="n">lanczos_h0</span> <span class="o">=</span> <span class="n">LanczosEvolution</span><span class="p">(</span><span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">,</span>
                                      <span class="n">psi0</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">]),</span>
                                      <span class="n">params</span><span class="o">=</span><span class="n">parameters_lanczos_h1</span><span class="p">)</span>
        <span class="n">s_new</span><span class="p">,</span> <span class="n">N_h0</span> <span class="o">=</span> <span class="n">lanczos_h0</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">s_new</span> <span class="o">=</span> <span class="n">s_new</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.vR)&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">s_new</span></div></div>


<div class="viewcode-block" id="H0_mixed"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.H0_mixed.html#tenpy.algorithms.tdvp.H0_mixed">[docs]</a><span class="k">class</span> <span class="nc">H0_mixed</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class defining the zero site Hamiltonian for Lanczos</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        left part of the environment</span>
<span class="sd">    Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        right part of the environment</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        left part of the environment</span>
<span class="sd">    Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        right part of the environment</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lp</span> <span class="o">=</span> <span class="n">Lp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">Rp</span>

    <span class="k">def</span> <span class="nf">matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.vR)&#39;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rp</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;wR&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;wL&#39;</span><span class="p">]))</span>
        <span class="c1">#TODO:next line not needed. Since the transpose does not do anything, should not cost anything. Keep for safety ?</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="s1">&#39;vR*&#39;</span><span class="p">,</span> <span class="s1">&#39;vL*&#39;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">iset_leg_labels</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="H1_mixed"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.H1_mixed.html#tenpy.algorithms.tdvp.H1_mixed">[docs]</a><span class="k">class</span> <span class="nc">H1_mixed</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class defining the one site Hamiltonian for Lanczos</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        left part of the environment</span>
<span class="sd">    Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        right part of the environment</span>
<span class="sd">    M : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        MPO which is applied to the &#39;p&#39; leg of theta</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        left part of the environment</span>
<span class="sd">    Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        right part of the environment</span>
<span class="sd">    W : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        MPO which is applied to the &#39;p0&#39; leg of theta</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lp</span> <span class="o">=</span> <span class="n">Lp</span>  <span class="c1"># a,ap,m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">Rp</span>  <span class="c1"># b,bp,n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">W</span>  <span class="c1"># m,n,i,ip</span>

    <span class="k">def</span> <span class="nf">matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.p.vR)&#39;</span><span class="p">])</span>
        <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lp</span>
        <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rp</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;wR&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;p*&#39;</span><span class="p">,</span> <span class="s1">&#39;wL&#39;</span><span class="p">]))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;wR&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;wL&#39;</span><span class="p">]))</span>
        <span class="c1">#TODO:next line not needed. Since the transpose does not do anything, should not cost anything. Keep for safety ?</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="s1">&#39;vR*&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vL*&#39;</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">iset_leg_labels</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">h</span></div>


<div class="viewcode-block" id="H2_mixed"><a class="viewcode-back" href="../../../reference/tenpy.algorithms.tdvp.H2_mixed.html#tenpy.algorithms.tdvp.H2_mixed">[docs]</a><span class="k">class</span> <span class="nc">H2_mixed</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class defining the two sites Hamiltonian for Lanczos</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        left part of the environment</span>
<span class="sd">    Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        right part of the environment</span>
<span class="sd">    W : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        MPO which is applied to the &#39;p0&#39; leg of theta</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    Lp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        left part of the environment</span>
<span class="sd">    Rp : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        right part of the environment</span>
<span class="sd">    W0 : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        MPO which is applied to the &#39;p0&#39; leg of theta</span>
<span class="sd">    W1 : :class:`tenpy.linalg.np_conserved.Array`</span>
<span class="sd">        MPO which is applied to the &#39;p1&#39; leg of theta</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Lp</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">W0</span><span class="p">,</span> <span class="n">W1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lp</span> <span class="o">=</span> <span class="n">Lp</span>  <span class="c1"># a,ap,m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rp</span> <span class="o">=</span> <span class="n">Rp</span>  <span class="c1"># b,bp,n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO0</span> <span class="o">=</span> <span class="n">W0</span>  <span class="c1"># m,n,i,ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO1</span> <span class="o">=</span> <span class="n">W1</span>

    <span class="k">def</span> <span class="nf">matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">split_legs</span><span class="p">([</span><span class="s1">&#39;(vL.p0.p1.vR)&#39;</span><span class="p">])</span>
        <span class="n">Lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lp</span>
        <span class="n">Rp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rp</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Lp</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO0</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;wR&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;p*&#39;</span><span class="p">,</span> <span class="s1">&#39;wL&#39;</span><span class="p">]))</span>
        <span class="n">x</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_MPO1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;wR&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;p*&#39;</span><span class="p">,</span> <span class="s1">&#39;wL&#39;</span><span class="p">]))</span>
        <span class="n">x</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">npc</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;vR&#39;</span><span class="p">,</span> <span class="s1">&#39;wR&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;wL&#39;</span><span class="p">]))</span>
        <span class="n">x</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;vL*&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">ireplace_label</span><span class="p">(</span><span class="s1">&#39;vR*&#39;</span><span class="p">,</span> <span class="s1">&#39;vL&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">combine_legs</span><span class="p">([</span><span class="s1">&#39;vL&#39;</span><span class="p">,</span> <span class="s1">&#39;p0&#39;</span><span class="p">,</span> <span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;vR&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">h</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userguide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Tenpy Reference</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">TeNPy 0.4.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2019, TeNPy Developers.
      Last updated on Sep 25, 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
  </body>
</html>